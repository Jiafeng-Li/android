# 							白夜极光后台服务器压力测试方案

 

版本控制

| 版本 | 日期       | 作者    | 备注 |
| ---- | ---------- | ------- | ---- |
| V1.0 | 2021.01.13 | Jocknie |      |
|      |            |         |      |
|      |            |         |      |
|      |            |         |      |

 

 

 

 

 

### 1． 概述

#### 1.1 背景介绍

本次压测的目的是，检测白夜极光游戏的核心业务系统的性能情况。保证业务在高并发的时候，系统也能稳定运行。因此希望完全模拟生产环境，模拟用户并发，对系统的核心业务进行压力测试，收集相关响应时间、以及对应系统的性能数据。并做为基线，对后续系统开发及优化提供参考。

#### 1.2 被测系统介绍

![Image text](../img/image.png)

| **服务器名** | **是否单点** | **功能说明**                                                 |
| ------------ | ------------ | :----------------------------------------------------------- |
| Bulletin     | 多台         | 客户端登录时连接的第1个服务器。主要功能有版本控制，给客户端分配合适的gateway和game。  客户端收到gateway和game 信息后，会立即断开bulletin之前的连接。 |
| Gateway      | 多台         | 网关服务器，负责转发客户端和逻辑连接层服务器之前的消息。在整个游戏过程中一直保持与客户端的连接。 |
| Game         | 多台         | 游戏主逻辑服务器，负责绝大部分游戏逻辑。                     |
| Match        | 多台         | 游戏对局服务器，负责对局玩法相关功能。                       |
| Transmit     | 多台         | 内部消息转发服务器。                                         |
| DB           | 多台         | 数据存储服务器，直接与mysql相连，处理内部其它服务器的数据请求。 |
| Third        | 多台         | 与第三方服务交互服务器。                                     |
| auth         | 多台         | 与第三方服务交互服务器，处理登录签名验证。                   |
| provide      | 多台         | 处理米大师发货请求。                                         |
| gmproxy      | 多台         | 处理IDIP请求服务器。                                         |
| assetflow    | **单点**     | 每日统计活跃玩家资产状况。                                   |
| unique       | **单点**     | 全区唯一服务器，提供需要处理全区数据的功能。                 |
| Redis        | 集群         | 使用腾讯提供的Redis 集群。                                   |
| Msdk server  | 集群         | 腾讯提供的帐号相关服务。                                     |
| Midas server | 集群         | 腾讯提供的支付相关服务。                                     |



#### 1.3 压测环境

##### 1.3.1 机器配置

| 服务器名称                      | 型号 | CPU        | 内存 | 硬盘     |
| ------------------------------- | ---- | ---------- | ---- | -------- |
| db（数据存储服务）              |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Transmit(内部消息转发服)        |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Gateway(网关服务器)             |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Game(游戏主逻辑服)              |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Match(游戏对局服)               |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Auth(签名验证服务器)            |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Bulletin(连接服务器)            |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Third（与第三方服务交互服务器） |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Gmproxy(处理IDIP请求服务器)     |      | 2.5GHz 4核 | 8G   | 硬盘200G |
| Unique(处理全区数据功能服务器)  |      | 2.5GHz 4核 | 8G   | 硬盘200G |



##### 1.3.2 机器部署



总共10台机器：

1台用于部署数据存储服务模块

1台用于部署内部消息转发服务模块

1台用于部署网光服务模块

1台用于游戏主逻辑服务模块

1台用于游戏对局服务模块

1台用于签名验证服务模块

1台用于连接服务器模块

1台用于与第三方服务交互服务模块

1台用于处理IDIP请求服务模块

1台用于处理全区数据服务模块



#### 1.4 压测框架

接入压测大师的上报API，开发商提供机器人，机器人数据上报压测大师.



#### 1.5 开发商预估

开发端预估单服在线人数5000



### 2. 压测场景

#### 2.1 登录

目的：压测登录系统、排队系统是否生效

实现逻辑：

登录版本服->登录帐号服->登录前台服->进入游戏首页->断开->登录前台服->循环



#### 2.2 闯关

##### 2.2.1 主线关卡

目的：压主线闯关系统的压力

实现逻辑：点开主线关卡->进入编队界面->修改编队->创建对局->退出对局



##### 2.2.2 资源本

目的：压资源本系统的压力

实现逻辑：进入资源本功能->打开双倍开关->进入某个资源本



##### 2.2.3 大秘境

目的：压大秘境系统的压力情况

实现逻辑：进入秘境->进如某个房间->调整编队



##### 2.2.4番外副本

目的：压番外副本系统的压力情况

实现逻辑：进入番外功能->进入章节->进入关卡入口



##### 2.2.5尖塔挑战

###### 2.2.5.1 尖塔挑战获取数据

目的：压尖塔挑战数据获取系统的压力情况



###### 2.2.5.2 尖塔挑战更改编队信息

目的：压同时多人更改编队信息的压力情况



###### 2.2.5.3 尖塔挑战全服通关数据

目的：压全服通光时的压力情况



#### 2.3 巨像



##### 2.3.1 更新好感度

##### 2.3.2 点击宝宝

##### 2.3.3 清理空间->建造建筑

##### 2.3.4 房间升级或降级顺序执行

##### 2.3.5 入驻星灵

##### 2.3.6 兑换萤火



#### 2.4  仓库

目的：压仓库系统中材料消耗的压力



#### 2.5 召集

目的：压抽卡系统的压力

逻辑：进入抽卡界面->抽卡



#### 2.6 光灵

##### 2.6.1 光灵随机剧情

目的：压光灵随机剧情系统的压力情况



##### 2.6.2 增加好感度

目的：压增加好感度系统的压力情况



##### 2.6.3 送礼物

##### 2.6.4 光灵突破

##### 2.6.5 光灵觉醒

##### 2.6.6 光灵升级



#### 2.7 商店

##### 2.7.1进入商店推荐页

目的：压进入商店推荐页时的压力情况



##### 2.7.2 进入某个具体商店

目的：进入某个具体的商店时的压力情况



##### 2.7.3刷新商店

目的：压进入商店后，刷新商店时的压力情况



##### 2.7.4 购买物品

目的：压进入某个商店 后，购买物品时的压力情况



#### 2.8 任务

##### 2.8.1 领取活跃度奖励

目的：压领取活跃度奖励时的压力情况



##### 2.8.2 领取成就奖励

目的：压领取成就奖励时的压力情况



##### 2.8.3 一键领取奖励

目的：压一键领取奖励时的压力情况



##### 2.8.4 领取某个任务的奖励 

目的：压用户在领取某个任务的奖励时压力情况



##### 2.8.5获取任务刷新时间

目的：压用户在获取任务刷新时间时的压力情况



#### 2.9 聊天

##### 2.9.1 获取在线玩家列表

目的：压拉取在线玩家列表的压力情况



##### 2.9.2 主动加好友

目的：压加好友场景的压力情况



##### 2.9.3 被动加好友

目的：压被动加好友时的压力情况



##### 2.9.4 友好度增加

目的：压友好度增加系统的压力情况



##### 2.9.5 删除好友

目的：压用户删除好友时的压力情况



##### 2.9.6 更新黑名单

目的：压用户在更新黑名单场景时的压力情况



##### 2.9.7 聊天

目的：压用户在聊天时的压力情况



##### 2.9.8 设置好友备注

目的：压用户设置好友备注时的 压力情况



##### 2.9.9 刷新推荐好友

目的：压刷新推荐好友数据时的压力情况



#### 3.0 邮件

##### 3.0.1获取邮件列表

目的：压获取邮件列表时压力情况



##### 3.0.2读取邮件

目的：压在读取邮件时的压力情况



##### 3.0.3 领取全部邮件

目的：压领取全部邮件时的压力情况

实现逻辑：领取某几封邮件->领取全部邮件



##### 3.0.4 删除邮件

目的：压删除邮件时的压力情况

试下逻辑：删除一封邮件->删除所有邮件



#### 3.1 综合场景

所有单场景综合一起跑，并按照先游数据各协议占比情况来分布综合场景机器人数：

| 压测场景                | 机器人占比 | 研发预计TPS | 测试预估TPS | 备注                     |
| ----------------------- | ---------- | ----------- | ----------- | ------------------------ |
| 登陆                    | 2%         | 10          | 20          |                          |
| 主线关卡闯关            | 6%         | 30          | 60          | 此场景用于测试Transmit服 |
| 资源本                  | 4%         | 20          | 40          |                          |
| 大秘境光卡闯关          | 4%         | 20          | 40          |                          |
| 番外光卡闯关            | 3%         | 15          | 30          |                          |
| 番外剧情操作            | 0.4%       | 2           | 4           |                          |
| 尖塔挑战-请求获取数据   | 3%         | 15          | 30          |                          |
| 尖塔挑战-更改编队信息   | 3%         | 15          | 30          |                          |
| 尖塔挑战-全服通关数据   | 3%         | 15          | 30          |                          |
| 巨像-更新好感度         | 1.6%       | 8           | 16          |                          |
| 巨像-点击宝宝           | 1.6%       | 8           | 16          |                          |
| 巨像-清理空间->建造建筑 | 0.2%       | 1           | 2           |                          |
| 巨像--房间升级          | 0.4%       | 2           | 4           |                          |
| 巨像-入驻星灵           | 3%         | 15          | 30          |                          |
| 巨像-兑换萤火           | 0.6%       | 3           | 6           |                          |
| 仓库使用物品            | 1.6%       | 8           | 16          |                          |
| 召集-进入抽卡界面       | 1%         | 5           | 10          |                          |
| 召集-抽卡               | 1.4%       | 7           | 14          |                          |
| 光灵-随机剧情           | 2%         | 10          | 20          |                          |
| 光灵-增加好感度         | 1%         | 5           | 10          |                          |
| 光灵-送礼物             | 0.4%       | 2           | 4           |                          |
| 光灵突破                | 0.4%       | 2           | 4           |                          |
| 光灵觉醒                | 0.4%       | 2           | 4           |                          |
| 光灵升级                | 1.6%       | 8           | 16          |                          |
| 进入商店推荐页          | 1.6%       | 8           | 16          |                          |
| 进入某个商店            | 2%         | 10          | 20          |                          |
| 请求刷新商店            | 0.4%       | 2           | 4           |                          |
| 购买物品                | 1%         | 5           | 10          |                          |
| 领取活跃度奖励          | 3%         | 15          | 30          |                          |
| 领取成就奖励            | 3%         | 15          | 30          |                          |
| 一键领取所有奖励        | 3%         | 15          | 30          |                          |
| 领取某个任务奖励        | 0.6%       | 3           | 6           |                          |
| 获取任务刷新时间        | 3%         | 15          | 30          |                          |
| 获取在线玩家列表        | 4%         | 20          | 40          |                          |
| 主动加好友              | 0.4%       | 2           | 4           |                          |
| 被动加好友              | 0.4%       | 2           | 4           |                          |
| 友好度增加              | 6%         | 30          | 60          |                          |
| 删除好友                | 0.14%      | 2           | 4           |                          |
| 更新黑名单              | 3%         | 15          | 30          |                          |
| 聊天                    | 6%         | 30          | 60          |                          |
| 设置好友备注            | 0.4%       | 2           | 4           |                          |
| 刷新推荐好友            | 4%         | 20          | 40          |                          |
| 获取邮件列表            | 2%         | 10          | 20          |                          |
| 读取邮件                | 3%         | 15          | 30          |                          |
| 领取全部邮件            | 4%         | 20          | 40          |                          |
| 删除所有邮件            | 2.8%       | 14          | 28          |                          |



### 3. 测试完成标准

##### 3.1 TDR3的标准

1. 针对服务器的技术规范要求，全部测试通过

2. 单服的综合场景测试下，必须满足性能基线（参考游戏容量建议表确定）要求，并且各事务 90% 响应时间 <1 秒，各事务成功率 >99.9%， CPU 消耗低于 80%

3. 稳定性测试运行 12 小时以上，切换不同批次账号，事务成功率 > 99.9%，无内存泄漏

4. 有条件的项目组建议搭建 50~100w PCU 的现网环境压测 7*24 小时，观察各节点压力、单机负载和事务情况

##### 3.2 关注的性能指标

- 并发数/TPS/响应时间/成功率

- CPU/内存/IO/网络

### 4.风险点

主程评估，压力主要在game服 、Transmit服的CPU，其他服压力不会太大。
